<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE TRANSMISSION // Encrypt</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>SECURE TRANSMISSION // Encryption Terminal</h2>
        <p>Encrypt any file (Text, Image, Video) using a custom password key.</p>
        <hr>

        <label for="password">Encryption Password (Key):</label>
        <input type="password" id="password" placeholder="Enter a secret password (min 4 chars)">

        <label for="fileInput">Upload File (Image, Video, or Text):</label>
        <input type="file" id="fileInput">

        <button onclick="processEncryption()">Encrypt & Generate .cyphr</button>

        <p style="margin-top: 20px;">
            <a href="index.html" style="color: var(--secondary-accent);"> &larr; Back to Index</a> |
            <a href="decrypt.html" style="color: var(--main-accent);">Decryption Terminal &rarr;</a>
        </p>
    </div>

    <script>
        const FILE_HEADER = "CYPHR_B64_V2:";
        const FILE_FOOTER = "//END_TX";
        
        function deriveKey(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                hash = (hash + password.charCodeAt(i) * 31) % 256;
            }
            return hash % 26; 
        }

        function customEncrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                let charCode = text.charCodeAt(i);
                result += String.fromCharCode(charCode + key);
            }
            return result;
        }
        
        function processEncryption() {
            const file = document.getElementById('fileInput').files[0];
            const password = document.getElementById('password').value.trim();

            if (!file) {
                alert("ERROR: Please upload a file.");
                return;
            }
            if (password.length < 4) {
                alert("ERROR: Password must be at least 4 characters long.");
                return;
            }

            const key = deriveKey(password);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result; 
                const rawBase64 = base64Data.split(',')[1] || base64Data; 

                const cipherText = customEncrypt(rawBase64, key);
                const fileContent = `${FILE_HEADER}${cipherText}${FILE_FOOTER}`;

                const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `secure_transmission.cyphr`; 
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`SUCCESS: File 'secure_transmission.cyphr' generated.`);
            };

            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>